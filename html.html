<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å˜‰ç¾©åœ‹ä¸­é–±è®€èªè­‰ç³»çµ±</title>
    <style>
        /* --- ç³»çµ±å…¨åŸŸè®Šæ•¸ --- */
        :root {
            --primary: #2c3e50;
            --accent: #27ae60;
            --bg: #f4f7f6;
            --white: #ffffff;
            --error: #e74c3c;
            --text: #333;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Noto Sans TC', sans-serif; }
        body { background-color: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; align-items: center; }

        /* --- Header --- */
        header { width: 100%; background: var(--primary); color: white; padding: 1.5rem; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header h1 { font-size: 1.5rem; }

        /* --- Main Layout --- */
        main { width: 100%; max-width: 800px; padding: 1.5rem; flex: 1; }

        /* --- Card & Section --- */
        .section-view { display: none; animation: fadeIn 0.4s ease; }
        .section-view.active { display: block; }
        .card { background: var(--white); border-radius: 10px; padding: 2rem; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Form Elements --- */
        .form-group { margin-bottom: 1.2rem; }
        label { display: block; font-weight: bold; margin-bottom: 0.5rem; color: var(--primary); }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1rem; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--accent); color: white; }
        .btn-outline { background: transparent; border: 1px solid #aaa; color: #555; }
        .btn:hover { opacity: 0.9; }

        /* --- Captcha --- */
        .captcha-box { display: flex; gap: 10px; margin-bottom: 10px; }
        .captcha-display { background: #eee; padding: 8px 15px; font-family: monospace; font-size: 1.5rem; letter-spacing: 3px; border-radius: 5px; flex: 1; text-align: center; text-decoration: line-through; }

        /* --- Dashboard (Book List) --- */
        .user-info { background: #e8f6f3; padding: 15px; border-left: 5px solid var(--accent); border-radius: 4px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .book-card { background: white; border: 1px solid #eee; border-radius: 8px; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; }
        .book-title { font-weight: bold; font-size: 1.1rem; color: var(--primary); margin-bottom: 5px; }
        .book-author { font-size: 0.9rem; color: #777; margin-bottom: 15px; }

        /* --- Quiz UI --- */
        .quiz-header { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .question-text { font-size: 1.3rem; font-weight: bold; margin-bottom: 20px; line-height: 1.6; }
        .option-btn { display: block; width: 100%; padding: 15px; margin-bottom: 10px; background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; text-align: left; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .option-btn:hover { background: #e2e6ea; border-color: #cbd3da; }
        .option-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- Result UI --- */
        .score-circle { width: 150px; height: 150px; background: var(--primary); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 3rem; margin: 20px auto; font-weight: bold; }
        .result-msg { text-align: center; font-size: 1.2rem; margin-bottom: 20px; }
        .pass { color: var(--accent); }
        .fail { color: var(--error); }

        /* --- Loading Overlay --- */
        #loading { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* RWD */
        @media(max-width: 600px) {
            .book-grid { grid-template-columns: 1fr; }
            .user-info { flex-direction: column; align-items: flex-start; gap: 10px; }
        }
    </style>
</head>
<body>

    <header><h1>å˜‰ç¾©åœ‹ä¸­é–±è®€èªè­‰ç³»çµ±</h1></header>

    <main>
        <!-- ğŸ”´ 1. ç™»å…¥ç•«é¢ -->
        <section id="view-login" class="section-view active">
            <div class="card" style="max-width: 450px; margin: 0 auto;">
                <h2 style="text-align: center; margin-bottom: 20px;">å­¸ç”Ÿç™»å…¥</h2>
                <form onsubmit="event.preventDefault(); login();">
                    <div class="form-group">
                        <label>å­¸è™Ÿ</label>
                        <input type="text" id="login-id" required>
                    </div>
                    <div class="form-group">
                        <label>ç­ç´š</label>
                        <select id="login-class" disabled><option>è¼‰å…¥ä¸­...</option></select>
                    </div>
                    <div class="form-group">
                        <label>åº§è™Ÿ</label>
                        <input type="number" id="login-seat" min="1" max="100" required>
                    </div>
                    <div class="form-group">
                        <label>é©—è­‰ç¢¼</label>
                        <div class="captcha-box">
                            <div id="captcha-show" class="captcha-display">ABCD</div>
                            <button type="button" class="btn-outline" style="width: auto;" onclick="genCaptcha()">ğŸ”„</button>
                        </div>
                        <input type="text" id="login-captcha" placeholder="è¼¸å…¥ä¸Šæ–¹ä»£ç¢¼" required>
                    </div>
                    <p id="login-msg" style="color:red; text-align:center; margin-bottom:10px;"></p>
                    <button type="submit" class="btn btn-primary">ç™»å…¥</button>
                </form>
            </div>
        </section>

        <!-- ğŸŸ  2. æ›¸ç±åˆ—è¡¨ (Dashboard) -->
        <section id="view-dashboard" class="section-view">
            <div class="user-info">
                <div id="user-display">ğŸ‘‹ æ­¡è¿å›ä¾†</div>
                <button class="btn-outline" style="width: auto; padding: 5px 15px; font-size: 0.9rem;" onclick="logout()">ç™»å‡º</button>
            </div>
            <h3 style="margin-bottom: 15px;">ğŸ“– è«‹é¸æ“‡æ›¸ç±é–‹å§‹æ¸¬é©—</h3>
            <div id="book-list" class="book-grid">
                <!-- æ›¸ç±å‹•æ…‹è¼‰å…¥ -->
            </div>
        </section>

        <!-- ğŸŸ¡ 3. æ¸¬é©—ä»‹é¢ -->
        <section id="view-quiz" class="section-view">
            <div class="card">
                <div class="quiz-header">
                    <span id="quiz-book-name">æ›¸å</span>
                    <span id="quiz-progress">ç¬¬ 1 / 10 é¡Œ</span>
                </div>
                <div id="quiz-content">
                    <div id="question-text" class="question-text">é¡Œç›®è¼‰å…¥ä¸­...</div>
                    <div id="options-container">
                        <!-- é¸é …å‹•æ…‹è¼‰å…¥ -->
                    </div>
                </div>
            </div>
        </section>

        <!-- ğŸŸ¢ 4. æ¸¬é©—çµæœ -->
        <section id="view-result" class="section-view">
            <div class="card" style="text-align: center;">
                <h2>æ¸¬é©—çµæŸ</h2>
                <div class="score-circle" id="result-score">0</div>
                <div id="result-msg" class="result-msg"></div>
                <button class="btn btn-primary" onclick="showView('view-dashboard')">è¿”å›æ›¸å–®</button>
            </div>
        </section>
    </main>

    <!-- Loading Mask -->
    <div id="loading"><div class="spinner"></div><p style="margin-top:10px;">è³‡æ–™è™•ç†ä¸­...</p></div>

    <script>
        // ===========================================
        // âš ï¸ è¨­å®šå€ï¼šè«‹å¡«å…¥æ‚¨çš„ Apps Script URL
        // ===========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbxGf6WOMrUtdeSskcILNbYP4dF4vxMX_Y4dxIjSFYwTzSS3dBpUt1OjcJpAngCPrTA/exec"; 

        // å…¨åŸŸè®Šæ•¸
        let captchaCode = "";
        let currentUser = null;
        let currentQuiz = { questions: [], index: 0, score: 0, bookId: "", bookTitle: "" };

        // åˆå§‹åŒ–
        window.onload = () => {
            genCaptcha();
            fetchClassList();
        };

        // --- API å‘¼å«å·¥å…· ---
        async function callApi(payload) {
            document.getElementById('loading').style.display = 'flex';
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain' } // é¿é–‹ CORS é¸é …è«‹æ±‚
                });
                return await res.json();
            } catch (err) {
                alert("é€£ç·šéŒ¯èª¤ï¼š" + err);
                return { success: false };
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // --- 1. ç³»çµ±åŠŸèƒ½ï¼šå–å¾—ç­ç´š ---
        async function fetchClassList() {
            if (API_URL.includes("è«‹å¡«å…¥")) return;
            const res = await callApi({ action: "getClassList" });
            const sel = document.getElementById('login-class');
            sel.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡ç­ç´š</option>';
            sel.disabled = false;
            if (res.success) {
                res.classes.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c; opt.text = c;
                    sel.add(opt);
                });
            }
        }

        // --- 2. ç™»å…¥é‚è¼¯ ---
        function genCaptcha() {
            const chars = "23456789ABCDEFGHJKLMNPQRSTUVWXYZ";
            captchaCode = Array(4).fill(0).map(() => chars[Math.floor(Math.random()*chars.length)]).join('');
            document.getElementById('captcha-show').textContent = captchaCode;
            document.getElementById('login-captcha').value = '';
        }

        async function login() {
            const inputCode = document.getElementById('login-captcha').value.toUpperCase();
            if (inputCode !== captchaCode) {
                document.getElementById('login-msg').textContent = "âŒ é©—è­‰ç¢¼éŒ¯èª¤";
                genCaptcha();
                return;
            }

            const payload = {
                action: "login",
                studentId: document.getElementById('login-id').value,
                class: document.getElementById('login-class').value,
                seat: document.getElementById('login-seat').value
            };

            const res = await callApi(payload);
            if (res.success) {
                currentUser = { ...payload, name: res.studentName };
                document.getElementById('user-display').textContent = `ğŸ‘‹ ${currentUser.class} ${currentUser.seat}è™Ÿ ${currentUser.name}`;
                document.getElementById('login-msg').textContent = "";
                fetchBooks(); // ç™»å…¥æˆåŠŸå¾ŒæŠ“æ›¸å–®
                showView('view-dashboard');
            } else {
                document.getElementById('login-msg').textContent = "âŒ " + res.message;
                genCaptcha();
            }
        }

        // --- 3. æ›¸å–®é‚è¼¯ ---
        async function fetchBooks() {
            const res = await callApi({ action: "getBookList" });
            const container = document.getElementById('book-list');
            container.innerHTML = '';

            if (res.success && res.books.length > 0) {
                res.books.forEach(book => {
                    const div = document.createElement('div');
                    div.className = 'book-card';
                    div.innerHTML = `
                        <div>
                            <div class="book-title">${book.title}</div>
                            <div class="book-author">ä½œè€…ï¼š${book.author}</div>
                        </div>
                        <button class="btn btn-success" onclick="startQuiz('${book.id}', '${book.title}')">é–‹å§‹æ¸¬é©—</button>
                    `;
                    container.appendChild(div);
                });
            } else {
                container.innerHTML = '<p>ç›®å‰æ²’æœ‰å¯ç”¨çš„æ›¸ç±ã€‚</p>';
            }
        }

        // --- 4. æ¸¬é©—é‚è¼¯ ---
        async function startQuiz(bookId, bookTitle) {
            const res = await callApi({ action: "getQuizQuestions", bookId: bookId });
            
            if (!res.success) {
                alert(res.message);
                return;
            }

            // åˆå§‹åŒ–æ¸¬é©—ç‹€æ…‹
            currentQuiz = {
                questions: res.questions,
                index: 0,
                score: 0,
                bookId: bookId,
                bookTitle: bookTitle
            };

            renderQuestion();
            showView('view-quiz');
        }

        function renderQuestion() {
            const q = currentQuiz.questions[currentQuiz.index];
            document.getElementById('quiz-book-name').textContent = currentQuiz.bookTitle;
            document.getElementById('quiz-progress').textContent = `ç¬¬ ${currentQuiz.index + 1} / ${currentQuiz.questions.length} é¡Œ`;
            document.getElementById('question-text').textContent = q.q;

            const optsContainer = document.getElementById('options-container');
            optsContainer.innerHTML = '';

            q.options.forEach((optText, i) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = `${i + 1}. ${optText}`;
                btn.onclick = () => handleAnswer(i + 1); // å‚³å…¥ 1~4
                optsContainer.appendChild(btn);
            });
        }

        function handleAnswer(selectedOption) {
            const q = currentQuiz.questions[currentQuiz.index];
            
            // åˆ¤æ–·å°éŒ¯ (é€™è£¡ç°¡å–®åšï¼šç­”å°åŠ  10 åˆ†)
            // æ³¨æ„ï¼šå¾Œç«¯å‚³ä¾†çš„ ans æ˜¯ 1~4 çš„æ•¸å­—
            if (String(selectedOption) === String(q.ans)) {
                currentQuiz.score += 10;
            }

            // ä¸‹ä¸€é¡Œ
            currentQuiz.index++;
            if (currentQuiz.index < currentQuiz.questions.length) {
                renderQuestion();
            } else {
                finishQuiz();
            }
        }

        async function finishQuiz() {
            // é¡¯ç¤ºçµæœ
            const score = currentQuiz.score;
            document.getElementById('result-score').textContent = score;
            
            const msgEl = document.getElementById('result-msg');
            if (score >= 80) {
                msgEl.textContent = "ğŸ‰ æ­å–œé€šéèªè­‰ï¼";
                msgEl.className = "result-msg pass";
            } else {
                msgEl.textContent = "ğŸ’ª åŠ æ²¹ï¼Œè«‹å†æ¥å†å²ï¼";
                msgEl.className = "result-msg fail";
            }

            showView('view-result');

            // èƒŒæ™¯ä¸Šå‚³æˆç¸¾
            await callApi({
                action: "submitScore",
                studentId: currentUser.studentId,
                studentName: currentUser.name,
                class: currentUser.class,
                bookId: currentQuiz.bookId,
                bookTitle: currentQuiz.bookTitle,
                score: score
            });
        }

        // --- è¼”åŠ©ï¼šè¦–åœ–åˆ‡æ› ---
        function showView(viewId) {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        function logout() {
            currentUser = null;
            location.reload();
        }
    </script>
</body>
</html>