<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å˜‰ç¾©åœ‹ä¸­é–±è®€èªè­‰ç³»çµ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Varela+Round&display=swap" rel="stylesheet">
    <style>
        /* --- ğŸ¨ 1. ç¹½ç´›ç«¥è¶£é¢¨æ ¼è¨­å®š (ç¶­æŒä¸è®Š) --- */
        :root {
            --primary-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --primary-solid: #00c6fb;
            --accent-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --accent-solid: #ff7eb3;
            --bg-color: #f3f8ff;
            --card-bg: #ffffff;
            --text-main: #4a4a4a;
            --text-sub: #7a7a7a;
            --success: #2ecc71;
            --error: #ff6b6b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(#e1efff 2px, transparent 2px);
            background-size: 30px 30px;
            color: var(--text-main);
            font-family: 'Varela Round', 'Noto Sans TC', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            width: 90%; max-width: 800px; margin-top: 20px;
            background: var(--primary-gradient); color: white; padding: 1.2rem;
            text-align: center; border-radius: 20px;
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }
        header h1 { font-size: 1.6rem; letter-spacing: 2px; text-shadow: 2px 2px 0px rgba(0,0,0,0.1); }

        main { width: 100%; max-width: 800px; padding: 20px; flex: 1; }

        .section-view { display: none; animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .section-view.active { display: block; }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.9) translateY(20px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }

        .card { background: var(--card-bg); border-radius: 25px; padding: 2.5rem; box-shadow: 0 15px 35px rgba(0,0,0,0.08); margin-bottom: 20px; border: 2px solid white; }

        /* Form Elements */
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; font-weight: bold; margin-bottom: 0.8rem; color: var(--primary-solid); font-size: 1.1rem; }
        input, select { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 1rem; background: #f9f9f9; transition: all 0.3s; color: var(--text-main); }
        input:focus, select:focus { outline: none; border-color: var(--primary-solid); background: white; box-shadow: 0 0 0 4px rgba(79, 172, 254, 0.2); }

        .btn { width: 100%; padding: 14px; border: none; border-radius: 50px; cursor: pointer; font-size: 1.1rem; font-weight: bold; transition: transform 0.2s, box-shadow 0.2s; display: inline-block; text-align: center; }
        .btn:active { transform: scale(0.95); }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.15); }
        .btn-primary { background: var(--primary-gradient); color: white; box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4); }
        .btn-success { background: var(--accent-gradient); color: white; box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4); }
        .btn-outline { background: white; border: 2px solid #e0e0e0; color: var(--text-sub); }
        .btn-outline:hover { border-color: var(--primary-solid); color: var(--primary-solid); }

        .captcha-box { display: flex; gap: 10px; margin-bottom: 10px; align-items: stretch; }
        .captcha-display { background: #ffeaa7; color: #d35400; padding: 10px; font-family: 'Courier New', monospace; font-size: 1.8rem; letter-spacing: 5px; border-radius: 12px; flex: 1; text-align: center; text-decoration: line-through; font-weight: bold; border: 2px dashed #fdcb6e; }

        /* Dashboard & Nav */
        .user-info { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 25px; border-left: 8px solid var(--primary-solid); }
        .nav-buttons { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .nav-buttons button { flex: 1; padding: 12px; min-width: 100px; border-radius: 15px; border: none; background: white; color: var(--text-main); box-shadow: 0 4px 10px rgba(0,0,0,0.05); font-weight: bold; transition: 0.3s; cursor: pointer; }
        .nav-buttons button:hover { background: var(--primary-solid); color: white; transform: translateY(-2px); }

        /* --- ğŸ†• åˆ†é¡æ¨™ç±¤ (Tabs) --- */
        #category-tabs {
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px;
            /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
            scrollbar-width: none; -ms-overflow-style: none;
        }
        #category-tabs::-webkit-scrollbar { display: none; }
        
        .tab-btn {
            padding: 8px 16px; border-radius: 20px; border: 2px solid #e0e0e0;
            background: white; color: #888; cursor: pointer; white-space: nowrap;
            font-weight: bold; transition: 0.3s;
        }
        .tab-btn.active {
            background: var(--primary-solid); color: white; border-color: var(--primary-solid);
            box-shadow: 0 4px 10px rgba(79, 172, 254, 0.4);
        }

        /* Books */
        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
        .book-card { background: white; border-radius: 20px; padding: 20px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 8px 20px rgba(0,0,0,0.05); transition: 0.3s; border: 1px solid #f0f0f0; }
        .book-card:hover { transform: translateY(-5px); border-color: var(--primary-solid); }
        .book-title { font-size: 1.2rem; font-weight: bold; color: var(--text-main); margin-bottom: 8px; }
        .book-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .book-author { font-size: 0.9rem; color: #aaa; background: #f9f9f9; padding: 4px 10px; border-radius: 20px; }
        .book-category { font-size: 0.8rem; color: var(--primary-solid); font-weight: bold; }

        /* Data Table */
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; margin-top: 10px; }
        .data-table th { color: #888; padding: 10px; font-size: 0.9rem; }
        .data-table td { background: white; padding: 15px; font-weight: bold; color: var(--text-main); border-top: 2px solid #f0f0f0; border-bottom: 2px solid #f0f0f0; }
        .data-table td:first-child { border-left: 2px solid #f0f0f0; border-top-left-radius: 15px; border-bottom-left-radius: 15px; }
        .data-table td:last-child { border-right: 2px solid #f0f0f0; border-top-right-radius: 15px; border-bottom-right-radius: 15px; }
        .rank-badge { display: inline-flex; width: 30px; height: 30px; justify-content: center; align-items: center; border-radius: 50%; color: white; box-shadow: 0 3px 6px rgba(0,0,0,0.2); font-weight: bold; }
        .rank-1 { background: linear-gradient(45deg, #ffd700, #f1c40f); transform: scale(1.2); }
        .rank-2 { background: linear-gradient(45deg, #bdc3c7, #95a5a6); }
        .rank-3 { background: linear-gradient(45deg, #e67e22, #d35400); }

        /* Quiz & Result */
        .quiz-header { display: flex; justify-content: space-between; margin-bottom: 20px; background: #f0f8ff; padding: 15px; border-radius: 15px; color: var(--primary-solid); font-weight: bold; }
        .question-text { font-size: 1.4rem; font-weight: bold; margin-bottom: 30px; line-height: 1.6; color: #333; }
        .option-btn { width: 100%; padding: 18px; margin-bottom: 15px; background: white; border: 2px solid #f0f0f0; border-radius: 15px; text-align: left; cursor: pointer; font-size: 1.1rem; transition: 0.2s; position: relative; box-shadow: 0 4px 0 #f0f0f0; }
        .option-btn:hover { background: #eef7ff; border-color: var(--primary-solid); transform: translateY(-2px); box-shadow: 0 6px 0 #dcedfc; }
        .option-btn:active { transform: translateY(2px); box-shadow: 0 0 0; }
        .score-circle { width: 180px; height: 180px; background: white; border: 8px solid var(--primary-solid); color: var(--primary-solid); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 4rem; margin: 30px auto; font-weight: bold; box-shadow: 0 10px 30px rgba(79, 172, 254, 0.2); }
        .pass { color: var(--success); border-color: var(--success); }
        .fail { color: var(--error); border-color: var(--error); }

        /* Loading */
        #loading { background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); display: none; position: fixed; top:0; left:0; width:100%; height:100%; z-index: 1000; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-solid); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media(max-width: 600px) { .nav-buttons { flex-direction: column; } .card { padding: 1.5rem; } header h1 { font-size: 1.3rem; } }
    </style>
</head>
<body>

    <header><h1>ğŸ“š å˜‰ç¾©åœ‹ä¸­é–±è®€èªè­‰ç³»çµ±</h1></header>

    <main>
        <!-- ğŸ”´ 1. ç™»å…¥ç•«é¢ -->
        <section id="view-login" class="section-view active">
            <div class="card" style="max-width: 480px; margin: 0 auto; border-top: 10px solid var(--primary-solid);">
                <h2 style="text-align: center; margin-bottom: 25px; color: var(--text-main);">ğŸš€ å­¸ç”Ÿç™»å…¥</h2>
                <form onsubmit="event.preventDefault(); login();">
                    <div class="form-group"><label>ğŸ« ç­ç´š</label><select id="login-class" disabled><option>è¼‰å…¥ä¸­...</option></select></div>
                    <div class="form-group"><label>ğŸªª åº§è™Ÿ</label><input type="number" id="login-seat" min="1" max="100" placeholder="ä¾‹å¦‚ï¼š5" required></div>
                    <div class="form-group"><label>ğŸ”¢ å­¸è™Ÿ</label><input type="text" id="login-id" placeholder="è«‹è¼¸å…¥å­¸è™Ÿ" required></div>
                    <div class="form-group"><label>ğŸ›¡ï¸ é©—è­‰ç¢¼</label>
                        <div class="captcha-box"><div id="captcha-show" class="captcha-display">ABCD</div><button type="button" class="btn-outline" style="width: auto; border-radius: 12px;" onclick="genCaptcha()">ğŸ”„</button></div>
                        <input type="text" id="login-captcha" placeholder="è¼¸å…¥ä¸Šæ–¹ä»£ç¢¼" required>
                    </div>
                    <p id="login-msg" style="color: var(--error); text-align:center; margin-bottom:15px; font-weight:bold;"></p>
                    <button type="submit" class="btn btn-primary">é–‹å§‹é–±è®€ä¹‹æ—…ï¼ğŸš€</button>
                </form>
            </div>
        </section>

        <!-- ğŸŸ  2. Dashboard -->
        <section id="view-dashboard" class="section-view">
            <div class="user-info">
                <div id="user-display" style="font-size: 1.3rem; font-weight: bold; margin-bottom: 15px; color: var(--primary-solid);">ğŸ‘‹ æ­¡è¿å›ä¾†</div>
                <div class="nav-buttons">
                    <button onclick="showView('view-dashboard')">ğŸ“š æ›¸ç±åˆ—è¡¨</button>
                    <button onclick="fetchHistory()">ğŸ“œ æˆ‘çš„ç´€éŒ„</button>
                    <button onclick="fetchLeaderboard()">ğŸ† å…¨æ ¡æ’è¡Œ</button>
                    <button onclick="logout()" style="background: #ff7675; color: white;">ç™»å‡º ğŸ‘‹</button>
                </div>
            </div>

            <h3 style="margin-bottom: 20px; font-size: 1.4rem; padding-left: 10px; border-left: 5px solid var(--accent-solid);">ğŸ“– æœ¬å­¸æœŸæ¨è–¦æ›¸å–®</h3>
            
            <!-- ğŸ†• æ–°å¢ï¼šåˆ†é¡æ¨™ç±¤å€åŸŸ -->
            <div id="category-tabs">
                <!-- JS è‡ªå‹•ç”ŸæˆæŒ‰éˆ• -->
            </div>

            <div id="book-list" class="book-grid"></div>
        </section>

        <!-- ğŸ“œ 3. æ­·å²ç´€éŒ„ -->
        <section id="view-history" class="section-view">
            <div class="card">
                <h2 style="margin-bottom: 20px; text-align: center; color: var(--primary-solid);">ğŸ“œ æˆ‘çš„å†’éšªç´€éŒ„</h2>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead><tr><th>ğŸ“… æ—¥æœŸ</th><th>ğŸ“– æ›¸å</th><th>ğŸ¯ åˆ†æ•¸</th></tr></thead>
                        <tbody id="history-list"></tbody>
                    </table>
                </div>
                <button class="btn btn-outline" style="margin-top: 25px;" onclick="showView('view-dashboard')">â¬…ï¸ è¿”å›é¦–é </button>
            </div>
        </section>

        <!-- ğŸ† 4. æ’è¡Œæ¦œ -->
        <section id="view-leaderboard" class="section-view">
            <div class="card">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="color: #f1c40f; text-shadow: 1px 1px 0 #e67e22; font-size: 1.8rem;">ğŸ† å…¨æ ¡é–±è®€è‹±é›„æ¦œ</h2>
                    <p style="color: #999; font-size: 0.9rem; margin-top: 5px;">(åƒ…é¡¯ç¤ºå‰ 10 å)</p>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead><tr><th>æ’å</th><th>ç­ç´š</th><th>å§“å</th><th>ç¸½ç©åˆ†</th></tr></thead>
                        <tbody id="leaderboard-list"></tbody>
                    </table>
                </div>
                <button class="btn btn-outline" style="margin-top: 25px;" onclick="showView('view-dashboard')">â¬…ï¸ è¿”å›é¦–é </button>
            </div>
        </section>

        <!-- ğŸŸ¡ 5. æ¸¬é©—ä»‹é¢ -->
        <section id="view-quiz" class="section-view">
            <div class="card">
                <div class="quiz-header"><span id="quiz-book-name">æ›¸å</span><span id="quiz-progress">ç¬¬ 1 / 10 é¡Œ</span></div>
                <div id="quiz-content"><div id="question-text" class="question-text">é¡Œç›®è¼‰å…¥ä¸­...</div><div id="options-container"></div></div>
            </div>
        </section>

        <!-- ğŸŸ¢ 6. æ¸¬é©—çµæœ -->
        <section id="view-result" class="section-view">
            <div class="card" style="text-align: center;">
                <h2 style="color: var(--text-main);">æ¸¬é©—çµæŸ</h2>
                <div class="score-circle" id="result-score">0</div>
                <div id="result-msg" class="result-msg" style="font-size: 1.5rem; font-weight: bold; margin-bottom: 20px;"></div>
                <button class="btn btn-primary" onclick="showView('view-dashboard')">ğŸ“š ç¹¼çºŒé–±è®€ä¸‹ä¸€æœ¬</button>
            </div>
        </section>
    </main>

    <div id="loading"><div class="spinner"></div><p style="margin-top:15px; font-weight:bold; color: var(--primary-solid);">è³‡æ–™è™•ç†ä¸­...</p></div>

    <script>
        // ===========================================
        // âš ï¸ è«‹å¡«å…¥æ‚¨çš„ Apps Script URL
        // ===========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbyGjJsjSQcHoYFu0TQPSG_DTO_CYd1z1s_B5pwDPWcfIpDa3DlgDC6r_WBngbC1889w/exec"; 

        // å…¨åŸŸè®Šæ•¸
        let captchaCode = "";
        let currentUser = null;
        let currentQuiz = { questions: [], index: 0, score: 0, bookId: "", bookTitle: "" };
        let allBooksData = []; // ğŸ†• å„²å­˜æ‰€æœ‰æ›¸ç±è³‡æ–™ï¼Œä¾›ç¯©é¸ç”¨

        window.onload = () => { genCaptcha(); fetchClassList(); };

        async function callApi(payload) {
            document.getElementById('loading').style.display = 'flex';
            try {
                const res = await fetch(API_URL, {
                    method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'text/plain' }
                });
                return await res.json();
            } catch (err) { alert("é€£ç·šéŒ¯èª¤ï¼š" + err); return { success: false }; } 
            finally { document.getElementById('loading').style.display = 'none'; }
        }

        async function fetchClassList() {
            if (API_URL.includes("è«‹å¡«å…¥")) return;
            const res = await callApi({ action: "getClassList" });
            const sel = document.getElementById('login-class');
            sel.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡ç­ç´š</option>';
            sel.disabled = false;
            if (res.success) res.classes.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.text = c; sel.add(opt); });
        }

        function genCaptcha() {
            const chars = "23456789ABCDEFGHJKLMNPQRSTUVWXYZ";
            captchaCode = Array(4).fill(0).map(() => chars[Math.floor(Math.random()*chars.length)]).join('');
            document.getElementById('captcha-show').textContent = captchaCode;
            document.getElementById('login-captcha').value = '';
        }

        async function login() {
            const inputCode = document.getElementById('login-captcha').value.toUpperCase();
            if (inputCode !== captchaCode) { document.getElementById('login-msg').textContent = "ğŸ›¡ï¸ é©—è­‰ç¢¼éŒ¯èª¤"; genCaptcha(); return; }
            const payload = { action: "login", studentId: document.getElementById('login-id').value, class: document.getElementById('login-class').value, seat: document.getElementById('login-seat').value };
            const res = await callApi(payload);
            if (res.success) {
                currentUser = { ...payload, name: res.studentName };
                document.getElementById('user-display').innerHTML = `ğŸ‘‹ ${currentUser.class} ${currentUser.seat}è™Ÿ <b>${currentUser.name}</b>`;
                document.getElementById('login-msg').textContent = "";
                fetchBooks(); // ç™»å…¥å¾ŒæŠ“å–æ›¸ç±
                showView('view-dashboard');
            } else { document.getElementById('login-msg').textContent = "ğŸš« " + res.message; genCaptcha(); }
        }

        // --- ğŸ“– æ›¸å–®è™•ç† (å«åˆ†é¡é‚è¼¯) ---
        async function fetchBooks() {
            const res = await callApi({ action: "getBookList" });
            if (res.success) {
                allBooksData = res.books; // å„²å­˜åˆ°å…¨åŸŸè®Šæ•¸
                renderCategoryTabs();     // 1. ç”¢ç”Ÿåˆ†é¡æŒ‰éˆ•
                renderBooks('å…¨éƒ¨');       // 2. é è¨­é¡¯ç¤ºå…¨éƒ¨
            }
        }

        // ç”¢ç”Ÿåˆ†é¡æŒ‰éˆ•
        function renderCategoryTabs() {
            const tabContainer = document.getElementById('category-tabs');
            
            // æŠ“å‡ºæ‰€æœ‰ä¸é‡è¤‡çš„åˆ†é¡
            const categories = ['å…¨éƒ¨', ...new Set(allBooksData.map(b => b.category).filter(c => c))];
            
            tabContainer.innerHTML = '';
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = cat === 'å…¨éƒ¨' ? 'tab-btn active' : 'tab-btn';
                btn.textContent = cat;
                btn.onclick = () => {
                    // åˆ‡æ›æŒ‰éˆ•æ¨£å¼
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    // ç¯©é¸æ›¸ç±
                    renderBooks(cat);
                };
                tabContainer.appendChild(btn);
            });
        }

        // æ¸²æŸ“æ›¸ç± (æ ¹æ“šåˆ†é¡ç¯©é¸)
        function renderBooks(filterCategory) {
            const container = document.getElementById('book-list');
            container.innerHTML = '';
            
            // ç¯©é¸é‚è¼¯
            const filteredBooks = filterCategory === 'å…¨éƒ¨' 
                ? allBooksData 
                : allBooksData.filter(b => b.category === filterCategory);

            if (filteredBooks.length > 0) {
                filteredBooks.forEach(book => {
                    const div = document.createElement('div');
                    div.className = 'book-card';
                    // è‹¥ç„¡åˆ†é¡å‰‡ä¸é¡¯ç¤ºåˆ†é¡æ¨™ç±¤
                    const catTag = book.category ? `<span class="book-category">#${book.category}</span>` : '';
                    
                    div.innerHTML = `
                        <div>
                            <div class="book-title">ğŸ“– ${book.title}</div>
                            <div class="book-meta">
                                <span class="book-author">âœï¸ ${book.author}</span>
                                ${catTag}
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="startQuiz('${book.id}', '${book.title}')">é–‹å§‹æŒ‘æˆ° ğŸ”¥</button>
                    `;
                    container.appendChild(div);
                });
            } else {
                container.innerHTML = '<p style="text-align:center; width:100%; color:#888;">ğŸ˜´ é€™å€‹åˆ†é¡ç›®å‰æ²’æœ‰æ›¸ç±ã€‚</p>';
            }
        }

        // --- æ¸¬é©—åŠŸèƒ½ ---
        async function startQuiz(bookId, bookTitle) {
            const res = await callApi({ action: "getQuizQuestions", bookId: bookId });
            if (!res.success) { alert(res.message); return; }
            currentQuiz = { questions: res.questions, index: 0, score: 0, bookId: bookId, bookTitle: bookTitle };
            renderQuestion();
            showView('view-quiz');
        }

        function renderQuestion() {
            const q = currentQuiz.questions[currentQuiz.index];
            document.getElementById('quiz-book-name').textContent = "ğŸ“– " + currentQuiz.bookTitle;
            document.getElementById('quiz-progress').textContent = `ğŸš© ç¬¬ ${currentQuiz.index + 1} / ${currentQuiz.questions.length} é¡Œ`;
            document.getElementById('question-text').textContent = q.q;
            const optsContainer = document.getElementById('options-container');
            optsContainer.innerHTML = '';
            q.options.forEach((optText, i) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = `${i + 1}. ${optText}`;
                btn.onclick = () => handleAnswer(i + 1);
                optsContainer.appendChild(btn);
            });
        }

        function handleAnswer(selectedOption) {
            const q = currentQuiz.questions[currentQuiz.index];
            if (String(selectedOption).trim() === String(q.ans).trim()) { currentQuiz.score += 10; }
            currentQuiz.index++;
            if (currentQuiz.index < currentQuiz.questions.length) { renderQuestion(); } else { finishQuiz(); }
        }

        async function finishQuiz() {
            const score = currentQuiz.score;
            document.getElementById('result-score').textContent = score;
            const msgEl = document.getElementById('result-msg');
            const scoreCircle = document.getElementById('result-score');
            if (score >= 80) { 
                msgEl.textContent = "ğŸ‰ å¤ªæ£’äº†ï¼æ­å–œé€šéèªè­‰ï¼"; msgEl.style.color = "var(--success)";
                scoreCircle.classList.remove('fail'); scoreCircle.classList.add('pass');
            } else { 
                msgEl.textContent = "ğŸ’ª åˆ¥æ°£é¤’ï¼Œå†æ¥å†å²ï¼"; msgEl.style.color = "var(--error)";
                scoreCircle.classList.remove('pass'); scoreCircle.classList.add('fail');
            }
            showView('view-result');
            await callApi({ action: "submitScore", studentId: currentUser.studentId, studentName: currentUser.name, class: currentUser.class, bookId: currentQuiz.bookId, bookTitle: currentQuiz.bookTitle, score: score });
        }

        // --- æ­·å²ç´€éŒ„èˆ‡æ’è¡Œæ¦œ ---
        async function fetchHistory() {
            const res = await callApi({ action: "getHistory", studentId: currentUser.studentId });
            const tbody = document.getElementById('history-list');
            tbody.innerHTML = '';
            if (res.success && res.history.length > 0) {
                res.history.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${item.date}</td><td>${item.bookTitle}</td><td>${item.score} åˆ†</td>`;
                    tbody.appendChild(tr);
                });
            } else { tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">ğŸ“­ å°šç„¡å†’éšªç´€éŒ„</td></tr>'; }
            showView('view-history');
        }

        async function fetchLeaderboard() {
            const res = await callApi({ action: "getLeaderboard" });
            const tbody = document.getElementById('leaderboard-list');
            tbody.innerHTML = '';
            if (res.success && res.leaderboard.length > 0) {
                res.leaderboard.forEach((item, index) => {
                    let rankClass = index < 3 ? `rank-${index+1}` : '';
                    let badge = index < 3 ? `<span class="rank-badge ${rankClass}">${index + 1}</span>` : `<span style="font-weight:bold; color:#888;">${index + 1}</span>`;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${badge}</td><td>${item.className}</td><td>${item.name}</td><td style="color:var(--primary-solid);">${item.total} åˆ†</td>`;
                    tbody.appendChild(tr);
                });
            } else { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">ğŸ’¤ å°šç„¡æ’è¡Œè³‡æ–™</td></tr>'; }
            showView('view-leaderboard');
        }

        function showView(viewId) {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function logout() { currentUser = null; location.reload(); }
    </script>
</body>
</html>