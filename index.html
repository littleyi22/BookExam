<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å˜‰ç¾©åœ‹ä¸­é–±è®€èªè­‰ç³»çµ±</title>
    <link href="https://script.google.com/macros/s/AKfycbyGjJsjSQcHoYFu0TQPSG_DTO_CYd1z1s_B5pwDPWcfIpDa3DlgDC6r_WBngbC1889w/exec">
    <style>
/* å»ºè­°æ›¸å–®æŒ‰éˆ•èˆ‡å½ˆçª— */
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-suggest { background: #f39c12; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #d35400; transition: 0.2s; }
        .btn-suggest:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #d35400; }
        .btn-suggest:active { transform: translateY(2px); box-shadow: 0 0 0; }
        
        #suggest-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2500; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .suggest-box { background: white; width: 90%; max-width: 400px; padding: 25px; border-radius: 20px; border-top: 10px solid #f39c12; animation: popIn 0.3s ease; }
        .suggest-textarea { width: 100%; height: 100px; padding: 10px; border: 2px solid #eee; border-radius: 10px; resize: none; margin: 15px 0; font-size: 1rem; }
        /* --- ğŸ¨ åŸºç¤é¢¨æ ¼è¨­å®š --- */
        :root {
            --primary-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --primary-solid: #00c6fb;
            --accent-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --accent-solid: #ff7eb3;
            --bg-color: #f3f8ff;
            --card-bg: #ffffff;
            --text-main: #4a4a4a;
            --text-sub: #7a7a7a;
            --success: #2ecc71;
            --error: #ff6b6b;
            --gold: #ffd700;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(#e1efff 2px, transparent 2px);
            background-size: 30px 30px;
            color: var(--text-main);
            font-family: 'Varela Round', 'Noto Sans TC', sans-serif;
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
        }

        header {
            width: 90%; max-width: 800px; margin-top: 20px;
            background: var(--primary-gradient); color: white; padding: 1.2rem;
            text-align: center; border-radius: 20px;
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
            z-index: 10;
        }
        header h1 { font-size: 1.6rem; letter-spacing: 2px; text-shadow: 2px 2px 0px rgba(0,0,0,0.1); }

        main { width: 100%; max-width: 800px; padding: 20px; flex: 1; padding-bottom: 100px; /* é ç•™ç©ºé–“çµ¦åº•éƒ¨æ’å */ }

        .section-view { display: none; animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .section-view.active { display: block; }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.9) translateY(20px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }

        .card { background: var(--card-bg); border-radius: 25px; padding: 2.5rem; box-shadow: 0 15px 35px rgba(0,0,0,0.08); margin-bottom: 20px; border: 2px solid white; position: relative; }

        /* Form Elements */
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; font-weight: bold; margin-bottom: 0.8rem; color: var(--primary-solid); font-size: 1.1rem; }
        input, select { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 1rem; background: #f9f9f9; transition: all 0.3s; color: var(--text-main); }
        input:focus, select:focus { outline: none; border-color: var(--primary-solid); background: white; box-shadow: 0 0 0 4px rgba(79, 172, 254, 0.2); }

        .btn { width: 100%; padding: 14px; border: none; border-radius: 50px; cursor: pointer; font-size: 1.1rem; font-weight: bold; transition: transform 0.2s, box-shadow 0.2s; display: inline-block; text-align: center; }
        .btn:active { transform: scale(0.95); }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.15); }
        .btn-primary { background: var(--primary-gradient); color: white; box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4); }
        .btn-success { background: var(--accent-gradient); color: white; box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4); }
        .btn-outline { background: white; border: 2px solid #e0e0e0; color: var(--text-sub); }
        .btn-outline:hover { border-color: var(--primary-solid); color: var(--primary-solid); }

        .captcha-box { display: flex; gap: 10px; margin-bottom: 10px; align-items: stretch; }
        .captcha-display { background: #ffeaa7; color: #d35400; padding: 10px; font-family: 'Courier New', monospace; font-size: 1.8rem; letter-spacing: 5px; border-radius: 12px; flex: 1; text-align: center; text-decoration: line-through; font-weight: bold; border: 2px dashed #fdcb6e; }

        .user-info { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 25px; border-left: 8px solid var(--primary-solid); }
        .nav-buttons { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .nav-buttons button { flex: 1; padding: 12px; min-width: 100px; border-radius: 15px; border: none; background: white; color: var(--text-main); box-shadow: 0 4px 10px rgba(0,0,0,0.05); font-weight: bold; transition: 0.3s; cursor: pointer; }
        .nav-buttons button:hover { background: var(--primary-solid); color: white; transform: translateY(-2px); }

        /* Search & Tabs */
        .search-container { position: relative; margin-bottom: 15px; }
        .search-container input { padding-left: 40px; border-radius: 50px; border-color: #b2bec3; }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 1.2rem; color: #b2bec3; }

        #category-tabs { display: flex; flex-wrap: wrap; gap: 10px; padding-bottom: 10px; margin-bottom: 15px; justify-content: flex-start; }
        .tab-btn { width: calc(20% - 8px); padding: 8px 5px; border-radius: 15px; border: 2px solid #e0e0e0; background: white; color: #888; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 0.9rem; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        @media(max-width: 600px) { .tab-btn { width: calc(33.33% - 7px); } }
        .tab-btn.active { background: var(--primary-solid); color: white; border-color: var(--primary-solid); box-shadow: 0 4px 10px rgba(79, 172, 254, 0.4); }

        /* Books & Quiz */
        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
        .book-card { background: white; border-radius: 20px; padding: 20px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 8px 20px rgba(0,0,0,0.05); transition: 0.3s; border: 1px solid #f0f0f0; }
        .book-card:hover { transform: translateY(-5px); border-color: var(--primary-solid); }
        .book-title { font-size: 1.2rem; font-weight: bold; color: var(--text-main); margin-bottom: 8px; }
        .book-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .book-author { font-size: 0.9rem; color: #aaa; background: #f9f9f9; padding: 4px 10px; border-radius: 20px; }
        .book-category { font-size: 0.8rem; color: var(--primary-solid); font-weight: bold; }

        .quiz-header { display: flex; justify-content: space-between; margin-bottom: 20px; background: #f0f8ff; padding: 15px; border-radius: 15px; color: var(--primary-solid); font-weight: bold; }
        .question-text { font-size: 1.4rem; font-weight: bold; margin-bottom: 30px; line-height: 1.6; color: #333; }
        .option-btn { width: 100%; padding: 18px; margin-bottom: 15px; background: white; border: 2px solid #f0f0f0; border-radius: 15px; text-align: left; cursor: pointer; font-size: 1.1rem; transition: 0.2s; position: relative; box-shadow: 0 4px 0 #f0f0f0; }
        .option-btn:hover { background: #eef7ff; border-color: var(--primary-solid); transform: translateY(-2px); box-shadow: 0 6px 0 #dcedfc; }
        .option-btn:active { transform: translateY(2px); box-shadow: 0 0 0; }
        
        .score-circle { width: 180px; height: 180px; background: white; border: 8px solid var(--primary-solid); color: var(--primary-solid); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 4rem; margin: 30px auto; font-weight: bold; box-shadow: 0 10px 30px rgba(79, 172, 254, 0.2); }
        .pass { color: var(--success); border-color: var(--success); }
        .fail { color: var(--error); border-color: var(--error); }
        .limit-reached { color: #95a5a6; border-color: #95a5a6; }

        /* --- ğŸ† æ’è¡Œæ¦œ & ç¨±è™Ÿæ¨£å¼ (New) --- */
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; margin-top: 10px; }
        .data-table th { color: #888; padding: 10px; font-size: 0.9rem; }
        .data-table td { background: white; padding: 15px; font-weight: bold; color: var(--text-main); border-top: 2px solid #f0f0f0; border-bottom: 2px solid #f0f0f0; vertical-align: middle; }
        .data-table td:first-child { border-left: 2px solid #f0f0f0; border-top-left-radius: 15px; border-bottom-left-radius: 15px; }
        .data-table td:last-child { border-right: 2px solid #f0f0f0; border-top-right-radius: 15px; border-bottom-right-radius: 15px; }
        
        /* ç¨±è™Ÿèˆ‡æ’å */
        .rank-title { display: block; font-size: 0.8rem; font-weight: normal; margin-top: 4px; color: #666; }
        
        /* ğŸŒŸ 1-10 åï¼šé‡‘è‰²å‹•æ…‹é‚Šæ¡† */
        .gold-border td {
            border-top: 3px solid transparent; border-bottom: 3px solid transparent;
            background: linear-gradient(white, white) padding-box, linear-gradient(90deg, #ffd700, #fdb931, #ffd700) border-box;
            background-size: 200% auto;
            animation: shine 3s linear infinite;
        }
        .gold-border td:first-child { border-left: 3px solid transparent; }
        .gold-border td:last-child { border-right: 3px solid transparent; }

        /* ğŸŒˆ 11-50 åï¼šå½©è‰²é‚Šæ¡† */
        .rainbow-border td {
            border-top: 2px solid transparent; border-bottom: 2px solid transparent;
            background: linear-gradient(white, white) padding-box, linear-gradient(90deg, #3498db, #9b59b6, #e74c3c, #f1c40f) border-box;
        }
        .rainbow-border td:first-child { border-left: 2px solid transparent; }
        .rainbow-border td:last-child { border-right: 2px solid transparent; }

        @keyframes shine { to { background-position: 200% center; } }

        /* æ’åæ•¸å­— */
        .rank-num { font-size: 1.2rem; font-weight: 900; color: #bdc3c7; }
        .rank-top3 { font-size: 1.5rem; color: #f1c40f; text-shadow: 1px 1px 0 rgba(0,0,0,0.1); }

        /* åº•éƒ¨å›ºå®šå€‹äººæ’å */
        #my-rank-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            padding: 15px; z-index: 100;
            display: none; justify-content: center;
        }
        .my-rank-container {
            width: 100%; max-width: 800px;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold;
        }
        .my-rank-info { display: flex; flex-direction: column; }
        .my-rank-title { color: var(--primary-solid); font-size: 0.9rem; }

        /* --- ğŸ“¢ å…¬å‘Šå½ˆçª— (New) --- */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-box { background: white; width: 90%; max-width: 500px; padding: 25px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: popIn 0.3s ease; border-top: 10px solid var(--accent-solid); }
        .modal-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 15px; color: var(--text-main); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .modal-content { font-size: 1.1rem; line-height: 1.6; color: #555; margin-bottom: 20px; white-space: pre-line; }
        .modal-date { font-size: 0.85rem; color: #999; text-align: right; margin-bottom: 20px; }

        #loading { background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); display: none; position: fixed; top:0; left:0; width:100%; height:100%; z-index: 3000; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-solid); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media(max-width: 600px) { .nav-buttons { flex-direction: column; } .card { padding: 1.5rem; } header h1 { font-size: 1.3rem; } }
		/* --- ğŸ† æ­·å±†æ¦®è­½æ¦œæ¨£å¼ --- */
		.contest-item { margin-bottom: 15px; border: 2px solid #eee; border-radius: 15px; overflow: hidden; transition: 0.3s; background: white; }
		.contest-header { background: #f9f9f9; padding: 15px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: var(--text-main); }
		.contest-header:hover { background: #eef7ff; color: var(--primary-solid); }
		.contest-date { font-size: 0.85rem; color: #999; font-weight: normal; margin-left: 10px; }
		.contest-body { display: none; padding: 20px; color: #555; line-height: 1.8; border-top: 1px solid #eee; white-space: pre-wrap; /* ä¿ç•™æ›è¡Œæ ¼å¼ */ background: #fff; }
		.contest-item.open .contest-body { display: block; animation: slideDown 0.3s ease-out; }
		.contest-item.open { border-color: var(--primary-solid); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
		@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
		/* --- ğŸ“œ æ¦®è­½æ¦œå…§å®¹ç¾åŒ– (æ–°å¢) --- */
.contest-body { 
    display: none; 
    padding: 0; /* æ¸…é™¤å…§è·ï¼Œè®“åˆ—è¡¨è²¼é½Šé‚Šç·£ */
    background: #fff; 
    border-top: 2px solid #f1c40f; /* é‡‘è‰²åˆ†éš”ç·š */
}

.contest-item.open .contest-body { 
    display: block; 
    animation: slideDown 0.3s ease-out; 
}

/* æ¯ä¸€è¡Œåå–®çš„æ¨£å¼ */
.award-row {
    padding: 12px 20px;
    border-bottom: 1px dashed #eee; /* è™›ç·šåˆ†éš” */
    color: #555;
    font-size: 1rem;
    line-height: 1.6;
    transition: all 0.2s; /* å‹•ç•«éæ¸¡ */
    display: flex;
    align-items: center; /* è®“åœ–ç¤ºè·Ÿæ–‡å­—å‚ç›´ç½®ä¸­ */
}

/* æœ€å¾Œä¸€è¡Œä¸è¦ç·š */
.award-row:last-child { border-bottom: none; }

/* éš”è¡Œè®Šè‰²æ•ˆæœ (æ–‘é¦¬ç´‹) - è®“é–±è®€æ›´æ¸…æ¥š */
.award-row:nth-child(even) { background-color: #fbfbfb; }

/* æ»‘é¼ ç§»éå»çš„æ•ˆæœ */
.award-row:hover { 
    background-color: #fff9e6; /* è®Šæˆæ·¡æ·¡çš„é‡‘è‰² */
    color: #d35400; /* æ–‡å­—è®Šæ·±æ©˜è‰² */
    padding-left: 30px; /* è¼•å¾®å‘å³ç¸®æ’ï¼Œæ›´æœ‰äº’å‹•æ„Ÿ */
    font-weight: bold;
}
/* --- ğŸ”„ é‡æ–°æŒ‘æˆ°æŒ‰éˆ•æ¨£å¼ --- */
.btn-retry {
    background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); /* æ·¡æ©˜æš–è‰²æ¼¸å±¤ */
    color: white;
    box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
    margin-top: 15px; /* èˆ‡ä¸Šæ–¹æŒ‰éˆ•ä¿æŒè·é›¢ */
}
.btn-retry:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(243, 156, 18, 0.4);
}
/* --- âš”ï¸ ç­ç´šå°æŠ—è³½æ¨£å¼ --- */
.pk-item { margin-bottom: 20px; }
.pk-info { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; color: #555; }
.pk-bar-bg { background: #eee; height: 24px; border-radius: 12px; overflow: hidden; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); position: relative; }
/* èƒ½é‡æ¢å‹•ç•«èˆ‡æ¼¸å±¤ */
.pk-bar-fill { 
    height: 100%; width: 0%; 
    border-radius: 12px; 
    transition: width 1.5s cubic-bezier(0.22, 1, 0.36, 1); /* å½ˆæ€§å‹•ç•« */
    display: flex; align-items: center; justify-content: flex-end; padding-right: 10px;
    color: white; font-size: 0.8rem; font-weight: bold; text-shadow: 1px 1px 0 rgba(0,0,0,0.2);
    /* é è¨­è—è‰² */
    background: linear-gradient(90deg, #4facfe, #00f2fe);
}

/* å‰ä¸‰åç‰¹æ®Šè‰² */
.pk-rank-1 .pk-bar-fill { background: linear-gradient(90deg, #ff9a9e, #fecfef, #ff9a9e); box-shadow: 0 0 10px #ff9a9e; } /* å† è»ç´…ç²‰ */
.pk-rank-2 .pk-bar-fill { background: linear-gradient(90deg, #a18cd1, #fbc2eb); } /* äºè»ç´« */
.pk-rank-3 .pk-bar-fill { background: linear-gradient(90deg, #f6d365, #fda085); } /* å­£è»æ©˜é‡‘ */

.pk-rank-icon { font-size: 1.2rem; margin-right: 5px; }

    </style>
</head>
<body>

    <header><h1>ğŸ“š å˜‰ç¾©åœ‹ä¸­é–±è®€èªè­‰ç³»çµ±</h1></header>

    <main>
        <!-- ğŸ”´ 1. ç™»å…¥ç•«é¢ -->
        <section id="view-login" class="section-view active">
            <div class="card" style="max-width: 480px; margin: 0 auto; border-top: 10px solid var(--primary-solid);">
                <h2 style="text-align: center; margin-bottom: 25px; color: var(--text-main);">ğŸš€ å­¸ç”Ÿç™»å…¥</h2>
                <form onsubmit="event.preventDefault(); login();">
                    <div class="form-group"><label>ğŸ« ç­ç´š</label><select id="login-class" disabled><option>è¼‰å…¥ä¸­...</option></select></div>
                    <div class="form-group"><label>ğŸªª åº§è™Ÿ</label><input type="number" id="login-seat" min="1" max="100" placeholder="ä¾‹å¦‚ï¼š5" required></div>
                    <div class="form-group"><label>ğŸ”¢ å­¸è™Ÿ</label><input type="text" id="login-id" placeholder="è«‹è¼¸å…¥å­¸è™Ÿ" required></div>
                    <div class="form-group"><label>ğŸ›¡ï¸ é©—è­‰ç¢¼</label>
                        <div class="captcha-box"><div id="captcha-show" class="captcha-display">ABCD</div><button type="button" class="btn-outline" style="width: auto; border-radius: 12px;" onclick="genCaptcha()">ğŸ”„</button></div>
                        <input type="text" id="login-captcha" placeholder="è¼¸å…¥ä¸Šæ–¹ä»£ç¢¼" required>
                    </div>
                    <p id="login-msg" style="color: var(--error); text-align:center; margin-bottom:15px; font-weight:bold;"></p>
                    <button type="submit" class="btn btn-primary">é–‹å§‹é–±è®€ä¹‹æ—…ï¼ğŸš€</button>
                </form>
            </div>
        </section>

        <!-- ğŸŸ  2. Dashboard -->
        <section id="view-dashboard" class="section-view">
            <div class="user-info">
                <div id="user-display" style="font-size: 1.3rem; font-weight: bold; margin-bottom: 15px; color: var(--primary-solid);">ğŸ‘‹ æ­¡è¿å›ä¾†</div>
                <div class="nav-buttons">
					<button onclick="showView('view-dashboard')" 
							style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
						ğŸ“š æ›¸ç±åˆ—è¡¨
					</button>

					<button onclick="fetchHistory()" 
							style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
						ğŸ“œ æˆ‘çš„ç´€éŒ„
					</button>

					<button onclick="fetchLeaderboard()" 
							style="background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); color: white;">
						ğŸ† å…¨æ ¡æ’è¡Œ
					</button>

					<button onclick="fetchContestHistory()" 
							style="background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); color: white;">
						ğŸ›ï¸ æ­·å±†æ¦®è­½æ¦œ
					</button>
<button onclick="fetchClassPK()" 
							style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); color: white;">
						âš”ï¸ ç­ç´šå°æŠ—
					</button>
					<button onclick="logout()" style="background: #ff7675; color: white;">
						ç™»å‡º ğŸ‘‹
					</button>
					
				</div>
            </div>

            <h3 style="margin-bottom: 10px; font-size: 1.4rem; padding-left: 10px; border-left: 5px solid var(--accent-solid);">ğŸ“– æœ¬å­¸æœŸæ¨è–¦æ›¸å–®</h3>
            
            <div class="search-container">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="search-input" placeholder="è¼¸å…¥æ›¸åé—œéµå­—å¿«é€Ÿæœå°‹..." oninput="filterBooks()">
            </div>

            <div id="category-tabs"></div>
            <div id="book-list" class="book-grid"></div>
        </section>

<!-- ğŸ“œ 3. æ­·å²ç´€éŒ„ -->
        <section id="view-history" class="section-view">
    <div class="card">
        <div class="history-header">
            <h2 style="color: var(--primary-solid); margin:0;">ğŸ“œ æˆ‘çš„å†’éšªç´€éŒ„</h2>
            <button class="btn-suggest" onclick="openSuggestModal()">ğŸ’¡ æˆ‘è¦æ¨è–¦å¥½æ›¸</button>
        </div>

        <div style="background: linear-gradient(135deg, #fff1eb 0%, #ace0f9 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
            <div>
                <div style="font-size: 0.9rem; color: #666; font-weight: bold;">ğŸ›ï¸ æ­·å²ç´¯ç©ç©åˆ†</div>
                <div style="font-size: 0.8rem; color: #888;">(ä¸Šå­¸æœŸä»¥å‰çš„æ¦®è€€)</div>
            </div>
            <div id="history-total-score" style="font-size: 2rem; font-weight: 900; color: #2980b9;">0</div>
        </div>
        <div style="overflow-x: auto;">
				
                
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead><tr><th>ğŸ“… æ—¥æœŸ</th><th>ğŸ“– æ›¸å</th><th>ğŸ”¢ æ¬¡æ•¸</th><th>ğŸ¯ åˆ†æ•¸</th></tr></thead>
                        <tbody id="history-list"></tbody>
                    </table>
                </div>
                <button class="btn btn-outline" style="margin-top: 25px;" onclick="showView('view-dashboard')">â¬…ï¸ è¿”å›é¦–é </button>
            </div>
        </section>

        <!-- ğŸ’¡ å»ºè­°æ›¸å–®å½ˆçª— (æ–°å¢) -->
        <div id="suggest-modal">
            <div class="suggest-box">
                <h3 style="color: #d35400; margin-bottom: 10px;">ğŸ’¡ æ¨è–¦å¥½æ›¸çµ¦è€å¸«</h3>
                <p style="color: #666; font-size: 0.9rem;">ä½ è¦ºå¾—å“ªæœ¬æ›¸å¾ˆå¥½çœ‹ï¼Œå¸Œæœ›åŠ å…¥èªè­‰ç³»çµ±å‘¢ï¼Ÿ</p>
                <textarea id="suggest-text" class="suggest-textarea" placeholder="è«‹è¼¸å…¥æ›¸åï¼Œæˆ–æ˜¯ç°¡å–®çš„æ¨è–¦ç†ç”±..."></textarea>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" onclick="closeSuggestModal()">å–æ¶ˆ</button>
                    <button class="btn btn-success" onclick="submitSuggestion()">é€å‡ºå»ºè­°</button>
                </div>
            </div>
        </div>
        <!-- ğŸ† 4. æ’è¡Œæ¦œ (é¡¯ç¤ºå‰ 100 å) -->
        <section id="view-leaderboard" class="section-view">
            <div class="card">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="color: #f1c40f; text-shadow: 1px 1px 0 #e67e22; font-size: 1.8rem;">ğŸ† å…¨æ ¡é–±è®€è‹±é›„æ¦œ</h2>
                    <p style="color: #999; font-size: 0.9rem; margin-top: 5px;">(é¡¯ç¤ºå‰ 100 åå¼·è€…)</p>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead><tr><th>æ’å</th><th>ç­ç´š</th><th>å§“å</th><th>ç¸½ç©åˆ†</th></tr></thead>
                        <tbody id="leaderboard-list"></tbody>
                    </table>
                </div>
                <div style="height: 60px;"></div> <!-- å¢Šé«˜ç”¨ -->
                <button class="btn btn-outline" style="margin-top: 25px;" onclick="showView('view-dashboard')">â¬…ï¸ è¿”å›é¦–é </button>
            </div>
        </section>
		<section id="view-class-pk" class="section-view">
    <div class="card">
        <div style="text-align: center; margin-bottom: 25px;">
            <h2 style="color: #ff6b6b; font-size: 1.8rem; text-shadow: 2px 2px 0 #eee;">âš”ï¸ ç­ç´šé–±è®€çˆ­éœ¸æˆ°</h2>
            <p style="color: #888;">å…¨ç­åœ˜çµï¼Œçˆ­å–æ¦®è€€ï¼(ä¾å¹³å‡ç©åˆ†æ’å)</p>
        </div>

        <div id="class-pk-list">
            <p style="text-align:center;">è¨ˆç®—æˆ°æ³ä¸­...</p>
        </div>

        <button class="btn btn-outline" style="margin-top: 25px;" onclick="showView('view-dashboard')">â¬…ï¸ è¿”å›é¦–é </button>
    </div>
</section>
		<section id="view-contest" class="section-view">
			<div class="card">
			<div style="text-align: center; margin-bottom: 20px;">
				<h2 style="color: #9b59b6; font-size: 1.8rem;">ğŸ›ï¸ æ­·å±†æ¯”è³½æ¦®è­½æ¦œ</h2>
				<p style="color: #999; font-size: 0.9rem;">ç´€éŒ„æ¯ä¸€åˆ»çš„å…‰æ¦®æ™‚åˆ»</p>
			</div>
        
			<div id="contest-list-container">
				<p style="text-align:center;">è¼‰å…¥ä¸­...</p>
			</div>

			<button class="btn btn-outline" style="margin-top: 25px;" onclick="showView('view-dashboard')">â¬…ï¸ è¿”å›é¦–é </button>
		</div>
</section>
        <!-- ğŸŸ¡ 5. æ¸¬é©—ä»‹é¢ -->
        <section id="view-quiz" class="section-view">
            <div class="card">
                <div class="quiz-header"><span id="quiz-book-name">æ›¸å</span><span id="quiz-progress">ç¬¬ 1 / 10 é¡Œ</span></div>
                <div id="quiz-content"><div id="question-text" class="question-text">é¡Œç›®è¼‰å…¥ä¸­...</div><div id="options-container"></div></div>
            </div>
        </section>

        <!-- ğŸŸ¢ 6. æ¸¬é©—çµæœ -->
		<section id="view-result" class="section-view">
    <div class="card" style="text-align: center;">
        <h2 style="color: var(--text-main);">æ¸¬é©—çµæŸ</h2>
        <div class="score-circle" id="result-score">0</div>
        <div id="result-msg" class="result-msg" style="font-size: 1.5rem; font-weight: bold; margin-bottom: 20px;"></div>
        <p id="limit-msg" style="color: #e67e22; font-weight: bold; margin-bottom: 10px;"></p>
        
        <button class="btn btn-primary" onclick="showView('view-dashboard')">ğŸ“š ç¹¼çºŒé–±è®€ä¸‹ä¸€æœ¬</button>
        
        <button class="btn btn-retry" onclick="retryQuiz()">ğŸ’ª é‡æ–°æŒ‘æˆ°</button>
        </div>
</section>
    </main>

    <!-- åº•éƒ¨å›ºå®šå€‹äººæ’å -->
    <div id="my-rank-footer">
        <div class="my-rank-container">
            <div class="my-rank-info">
                <span id="my-rank-val" style="font-size: 1.2rem; color: #4a4a4a;">æˆ‘çš„æ’åï¼š--</span>
                <span id="my-rank-title" class="my-rank-title">ç¨±è™Ÿï¼š--</span>
            </div>
            <div id="my-rank-score" style="color: var(--primary-solid); font-size: 1.2rem;">0 åˆ†</div>
        </div>
    </div>

    <!-- å…¬å‘Šå½ˆçª— -->
    <div id="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" id="modal-title">ğŸ“¢ å…¬å‘Šæ¨™é¡Œ</div>
            <div class="modal-content" id="modal-content">å…¬å‘Šå…§å®¹...</div>
            <div class="modal-date" id="modal-date">2024/01/01</div>
            <button class="btn btn-primary" onclick="closeModal()">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <div id="loading"><div class="spinner"></div><p style="margin-top:15px; font-weight:bold; color: var(--primary-solid);">è³‡æ–™è™•ç†ä¸­...</p></div>

    <script>
        // ===========================================
        // âš ï¸ è«‹å¡«å…¥æ‚¨çš„ Apps Script URL
        // ===========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbyGjJsjSQcHoYFu0TQPSG_DTO_CYd1z1s_B5pwDPWcfIpDa3DlgDC6r_WBngbC1889w/exec"; 

        // å…¨åŸŸè®Šæ•¸
        let captchaCode = "";
        let currentUser = null;
        let currentQuiz = { questions: [], index: 0, score: 0, bookId: "", bookTitle: "" };
        let allBooksData = []; 
        let currentCategory = 'å…¨éƒ¨';

        window.onload = () => { genCaptcha(); fetchClassList(); };

        async function callApi(payload) {
            document.getElementById('loading').style.display = 'flex';
            try {
                const res = await fetch(API_URL, {
                    method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'text/plain' }
                });
                return await res.json();
            } catch (err) { alert("é€£ç·šéŒ¯èª¤ï¼š" + err); return { success: false }; } 
            finally { document.getElementById('loading').style.display = 'none'; }
        }

        async function fetchClassList() {
            if (API_URL.includes("è«‹å¡«å…¥")) return;
            const res = await callApi({ action: "getClassList" });
            const sel = document.getElementById('login-class');
            sel.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡ç­ç´š</option>';
            sel.disabled = false;
            if (res.success) res.classes.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.text = c; sel.add(opt); });
        }

        function genCaptcha() {
            const chars = "23456789ABCDEFGHJKLMNPQRSTUVWXYZ";
            captchaCode = Array(4).fill(0).map(() => chars[Math.floor(Math.random()*chars.length)]).join('');
            document.getElementById('captcha-show').textContent = captchaCode;
            document.getElementById('login-captcha').value = '';
        }

async function login() {
            const inputCode = document.getElementById('login-captcha').value.toUpperCase();
            if (inputCode !== captchaCode) { 
                document.getElementById('login-msg').textContent = "ğŸ›¡ï¸ é©—è­‰ç¢¼éŒ¯èª¤"; 
                genCaptcha(); 
                return; 
            }
            
            const payload = { 
                action: "login", 
                studentId: document.getElementById('login-id').value, 
                class: document.getElementById('login-class').value, 
                seat: document.getElementById('login-seat').value 
            };

            const res = await callApi(payload);
            
            if (res.success) {
                // âœ… ç™»å…¥æˆåŠŸ
                currentUser = { ...payload, name: res.studentName, historyScore: res.historyScore };
                
                document.getElementById('user-display').innerHTML = `ğŸ‘‹ ${currentUser.class} ${currentUser.seat}è™Ÿ <b>${currentUser.name}</b>`;
                document.getElementById('login-msg').textContent = "";
                
                fetchBooks();
                showView('view-dashboard');
                fetchAnnouncement(); 
            } else { 
                // âŒ ç™»å…¥å¤±æ•—
                document.getElementById('login-msg').textContent = "ğŸš« " + res.message; 
                genCaptcha(); 
            }
        }

        async function fetchAnnouncement() {
            const res = await callApi({ action: "getAnnouncement" });
            if (res.success && res.news) {
                document.getElementById('modal-title').textContent = "ğŸ“¢ " + res.news.title;
                document.getElementById('modal-content').textContent = res.news.content;
                document.getElementById('modal-date').textContent = "ç™¼å¸ƒæ—¥æœŸï¼š" + res.news.date;
                document.getElementById('modal-overlay').style.display = 'flex';
            }
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        async function fetchBooks() {
            const res = await callApi({ action: "getBookList" });
            if (res.success) {
				// ğŸ‘‡ æ›¸å–®ç”±å¤§åˆ°å°æ’åˆ—
                allBooksData = res.books.reverse();
				
                renderCategoryTabs();
                renderBooks();
            }
        }

        function renderCategoryTabs() {
            const tabContainer = document.getElementById('category-tabs');
            const categories = ['å…¨éƒ¨', ...new Set(allBooksData.map(b => b.category).filter(c => c))];
            tabContainer.innerHTML = '';
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = cat === 'å…¨éƒ¨' ? 'tab-btn active' : 'tab-btn';
                btn.textContent = cat;
                btn.onclick = () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCategory = cat;
                    renderBooks();
                };
                tabContainer.appendChild(btn);
            });
        }

		function renderBooks() {
            const container = document.getElementById('book-list');
            // é€™è£¡ä¹ŸåŠ ä¸€å€‹ä¿è­·ï¼Œç¢ºä¿æœå°‹è¼¸å…¥æ¡†çš„å€¼ä¹Ÿæ˜¯å®‰å…¨çš„
            const searchInput = document.getElementById('search-input');
            const searchText = searchInput ? searchInput.value.toLowerCase().trim() : "";
            
            container.innerHTML = '';
            
            // ğŸ” ä¿®æ­£é‡é»åœ¨ filter é€™ä¸€å¡Š
            const filteredBooks = allBooksData.filter(b => {
                const matchCategory = currentCategory === 'å…¨éƒ¨' || b.category === currentCategory;
                
                // ğŸ‘‡ ä¿®æ”¹é–‹å§‹ï¼šå¼·åˆ¶è½‰æˆæ–‡å­—æ ¼å¼ï¼Œé¿å…å ±éŒ¯ ğŸ‘‡
                const titleSafe = String(b.title || "").toLowerCase(); 
                const authorSafe = String(b.author || "").toLowerCase();
                // ğŸ‘† ä¿®æ”¹çµæŸ ğŸ‘†

                const matchSearch = titleSafe.includes(searchText) || authorSafe.includes(searchText);
                return matchCategory && matchSearch;
            });

            if (filteredBooks.length > 0) {
                filteredBooks.forEach(book => {
                    const div = document.createElement('div');
                    div.className = 'book-card';
                    const catTag = book.category ? `<span class="book-category">#${book.category}</span>` : '';
                    div.innerHTML = `<div><div class="book-title">ğŸ“– ${book.title}</div><div class="book-meta"><span class="book-author">âœï¸ ${book.author}</span>${catTag}</div></div><button class="btn btn-success" onclick="startQuiz('${book.id}', '${book.title}')">é–‹å§‹æŒ‘æˆ° ğŸ”¥</button>`;
                    container.appendChild(div);
                });
            } else { 
                container.innerHTML = '<p style="text-align:center; width:100%; color:#888;">ğŸ˜´ æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ›¸ç±ã€‚</p>'; 
            }
        }

        async function startQuiz(bookId, bookTitle) {
            const res = await callApi({ action: "getQuizQuestions", bookId: bookId });
            if (!res.success) { alert(res.message); return; }
            currentQuiz = { questions: res.questions, index: 0, score: 0, bookId: bookId, bookTitle: bookTitle };
            renderQuestion();
            showView('view-quiz');
        }

        function renderQuestion() {
            const q = currentQuiz.questions[currentQuiz.index];
            document.getElementById('quiz-book-name').textContent = "ğŸ“– " + currentQuiz.bookTitle;
            document.getElementById('quiz-progress').textContent = `ğŸš© ç¬¬ ${currentQuiz.index + 1} / ${currentQuiz.questions.length} é¡Œ`;
            document.getElementById('question-text').textContent = q.q;
            const optsContainer = document.getElementById('options-container');
            optsContainer.innerHTML = '';
            q.options.forEach((optText, i) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = `${i + 1}. ${optText}`;
                btn.onclick = () => handleAnswer(i + 1);
                optsContainer.appendChild(btn);
            });
        }

        function handleAnswer(selectedOption) {
            const q = currentQuiz.questions[currentQuiz.index];
            const points = 100 / currentQuiz.questions.length;
            if (String(selectedOption).trim() === String(q.ans).trim()) { currentQuiz.score += points; }
            currentQuiz.index++;
            if (currentQuiz.index < currentQuiz.questions.length) { renderQuestion(); } else { finishQuiz(); }
        }

        async function finishQuiz() {
            const score = Math.round(currentQuiz.score);
            document.getElementById('result-score').textContent = score;
            const msgEl = document.getElementById('result-msg');
            const limitMsgEl = document.getElementById('limit-msg');
            const scoreCircle = document.getElementById('result-score');
            
            limitMsgEl.textContent = ""; scoreCircle.className = "score-circle"; 

            const res = await callApi({ 
                action: "submitScore", studentId: currentUser.studentId, studentName: currentUser.name, class: currentUser.class, bookId: currentQuiz.bookId, bookTitle: currentQuiz.bookTitle, score: score 
            });

            if (res.limitReached) {
                msgEl.textContent = "ğŸ›‘ æ¬¡æ•¸å·²é”ä¸Šé™"; msgEl.style.color = "#95a5a6";
                limitMsgEl.textContent = `(æœ¬æ›¸å·²æŒ‘æˆ° ${res.attempts} æ¬¡ï¼Œæœ¬æ¬¡åˆ†æ•¸ä¸åˆ—å…¥è¨ˆç®—)`;
                scoreCircle.classList.add('limit-reached');
            } else {
                if (score >= 80) { 
                    msgEl.textContent = "ğŸ‰ å¤ªæ£’äº†ï¼é€šéèªè­‰ï¼"; msgEl.style.color = "var(--success)"; scoreCircle.classList.add('pass');
                } else { 
                    msgEl.textContent = "ğŸ’ª åˆ¥æ°£é¤’ï¼Œå†æ¥å†å²ï¼"; msgEl.style.color = "var(--error)"; scoreCircle.classList.add('fail');
                }
            }
            showView('view-result');
        }

// --- ğŸ”„ é‡æ–°æŒ‘æˆ°åŠŸèƒ½ ---
function retryQuiz() {
    // 1. é‡ç½®æ¸¬é©—ç‹€æ…‹ (åˆ†æ•¸æ­¸é›¶ã€å›åˆ°ç¬¬ä¸€é¡Œ)
    currentQuiz.index = 0;
    currentQuiz.score = 0;
    
    // 2. é‡æ–°æ¸²æŸ“ç¬¬ä¸€é¡Œ
    renderQuestion();
    
    // 3. åˆ‡æ›å›æ¸¬é©—ç•«é¢
    showView('view-quiz');
}


// --- ä¿®æ”¹å¾Œçš„ fetchHistory (å‰ç«¯é¡¯ç¤ºé‚è¼¯) ---
async function fetchHistory() {
    // 1. è™•ç†æ­·å²ç©åˆ†é¡¯ç¤º (æ”¯æ´åˆ†å­¸æœŸ)
    const scoreBox = document.getElementById('history-total-score');
    let historyHtml = '';
    
    try {
        // å˜—è©¦è§£æ JSON (ä¾‹å¦‚: {"112ä¸Š": 200, "112ä¸‹": 50})
        let rawScore = currentUser.historyScore;
        // å¦‚æœæ˜¯å­—ä¸²æ ¼å¼çš„ JSONï¼Œå…ˆè½‰ç‰©ä»¶
        if (typeof rawScore === 'string' && rawScore.startsWith('{')) {
            rawScore = JSON.parse(rawScore);
        }

        if (typeof rawScore === 'object' && rawScore !== null) {
            // å¦‚æœæ˜¯ç‰©ä»¶ï¼Œå°±è¿´åœˆé¡¯ç¤ºæ¯ä¸€å­¸æœŸ
            let totalSum = 0;
            for (let term in rawScore) {
                let s = rawScore[term];
                totalSum += s;
                historyHtml += `<div style="font-size:0.9rem; margin-top:3px;">
                                  <span style="color:#666;">${term}:</span> 
                                  <span style="color:#2980b9; font-weight:bold;">${s}</span>
                                </div>`;
            }
            // æœ€ä¸Šé¢é¡¯ç¤ºåŠ ç¸½
            historyHtml = `<div style="font-size:1.8rem; font-weight:900; color:#2980b9;">${totalSum}</div>` + historyHtml;
        } else {
            // èˆŠç‰ˆ (ç´”æ•¸å­—)
            historyHtml = `<div style="font-size:2rem; font-weight:900; color:#2980b9;">${rawScore || 0}</div>`;
        }
    } catch (e) {
        historyHtml = `<div style="font-size:2rem; font-weight:900; color:#2980b9;">0</div>`;
    }
    
    scoreBox.innerHTML = historyHtml;
    // (ç¨å¾®èª¿æ•´ä¸€ä¸‹ scoreBox çš„ CSS è®“å®ƒèƒ½å‚ç›´æ’åˆ—)
    scoreBox.style.flexDirection = 'column';
    scoreBox.style.alignItems = 'flex-end';
    scoreBox.style.fontSize = '1rem'; // é‡ç½®é è¨­å¤§å°

    // 2. å‘¼å« API å–å¾—åˆ—è¡¨ (é€™éƒ¨åˆ†ä¸ç”¨è®Š)
    const res = await callApi({ action: "getHistory", studentId: currentUser.studentId });
    const tbody = document.getElementById('history-list');
    tbody.innerHTML = '';

    if (res.success && res.history.length > 0) {
        res.history.forEach(item => {
            const tr = document.createElement('tr');
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºä¸è¨ˆåˆ†
            let scoreDisplay = `${item.score} åˆ†`;
            if (item.note === "ä¸è¨ˆåˆ†") {
                scoreDisplay = `<span style="color:#aaa; text-decoration:line-through;">${item.score}</span> <span style="font-size:0.8rem; color:#e74c3c;">(ä¸è¨ˆ)</span>`;
            }
            
            // åŠ å…¥å­¸æœŸæ¨™ç±¤ (ä¾‹å¦‚ï¼š[æ­·å¹´] æˆ– [æœ¬å­¸æœŸ])
            let termTag = item.term === "æ­·å¹´" ? `<span style="background:#ffeaa7; font-size:0.7rem; padding:2px 5px; border-radius:5px; margin-right:5px;">å­˜æ‘º</span>` : ``;

            tr.innerHTML = `
                <td>${item.date}</td>
                <td>${termTag}${item.bookTitle}</td>
                <td style="text-align:center;"><span style="background:#eee; padding:2px 8px; border-radius:10px; font-size:0.85rem;">ç¬¬ ${item.nth} æ¬¡</span></td>
                <td>${scoreDisplay}</td>
            `;
            tbody.appendChild(tr);
        });
    } else { 
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">ğŸ“­ å°šç„¡å†’éšªç´€éŒ„</td></tr>'; 
    }
    showView('view-history');
}


        // --- ğŸ† è£œå›ï¼šæ’è¡Œæ¦œé‚è¼¯ (é€™æ˜¯åœ¨å¤–é¢ï¼Œç¨ç«‹çš„å‡½å¼) ---
        async function fetchLeaderboard() {
            // å‚³å…¥ currentUser.studentId ä»¥ç²å–å€‹äººæ’å
            const res = await callApi({ action: "getLeaderboard", studentId: currentUser.studentId });
            const tbody = document.getElementById('leaderboard-list');
            tbody.innerHTML = '';

            if (res.success && res.leaderboard.length > 0) {
                res.leaderboard.forEach((item) => {
                    const rank = item.rank;
                    const title = getRankTitle(rank, item.total);
                    
                    // æ±ºå®šé‚Šæ¡†æ¨£å¼
                    let rowClass = "";
                    if (rank <= 10) rowClass = "gold-border";
                    else if (rank <= 50) rowClass = "rainbow-border";

                    // è™•ç†å‰ä¸‰åé¡¯ç¤º
                    let rankDisplay = `<span class="rank-num">${rank}</span>`;
                    if(rank <= 3) rankDisplay = `<span class="rank-num rank-top3">#${rank}</span>`;

                    const tr = document.createElement('tr');
                    tr.className = rowClass;
                    tr.innerHTML = `
                        <td style="text-align:center;">${rankDisplay}</td>
                        <td>${item.className}</td>
                        <td>
                            ${item.name}
                            <span class="rank-title">${title}</span>
                        </td>
                        <td style="color:var(--primary-solid);">${item.total}</td>
                    `;
                    tbody.appendChild(tr);
                });

                // æ›´æ–°åº•éƒ¨å€‹äººæ’å
                document.getElementById('my-rank-footer').style.display = 'flex';
                if (res.myRank) {
                    const r = res.myRank.rank;
                    const s = res.myRank.total;
                    document.getElementById('my-rank-val').textContent = `æˆ‘çš„æ’åï¼š${r}`;
                    document.getElementById('my-rank-score').textContent = `${s} åˆ†`;
                    document.getElementById('my-rank-title').textContent = `ç¨±è™Ÿï¼š${getRankTitle(r, s)}`;
                }

            } else { 
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">ğŸ’¤ å°šç„¡æ’è¡Œè³‡æ–™</td></tr>'; 
                document.getElementById('my-rank-footer').style.display = 'none';
            }
            showView('view-leaderboard');
        }

        // --- ğŸ–ï¸ è£œå›ï¼šç¨±è™Ÿç³»çµ±é‚è¼¯ (é€™ä¹Ÿæ˜¯åœ¨å¤–é¢) ---
        function getRankTitle(rank, score) {
            if (score === 0) return "ğŸ’¤ æ²‰ç¡çš„å‹‡è€…";
            if (!rank || rank === "-") return "ğŸŒ± æ—…é€”åˆå¿ƒè€…";

            if (rank === 1) return "ğŸ‘‘ å‚³å¥‡ï¼é–±è®€éœ¸ä¸»";
            if (rank === 2) return "âš”ï¸ æ¦®è€€ï¼å²è©©ç‹è€…";
            if (rank === 3) return "ğŸ’ ç’€ç’¨ï¼çµ•ä¸–é‘½çŸ³";
            if (rank === 4) return "âšœï¸ è¯è²´ï¼æ™ºæ…§æ³•çš‡";
            if (rank === 5) return "ğŸ”¥ ä¸æœ½ï¼æ™ºæ…§æˆ°ç¥";
            if (rank === 6) return "ğŸ”® å¥§ç§˜ï¼çŸ¥è­˜æ³•ç‹";
            if (rank === 7) return "ğŸ›¡ï¸ ç¥è–ï¼æ™ºæ…§è–é¨";
            if (rank === 8) return "ğŸ‰ éœ¸æ°£ï¼æ›¸æµ·é¾é¨";
            if (rank === 9) return "ğŸ©¸ ç†±è¡€ï¼é–±è®€é ˜ä¸»";
            if (rank === 10) return "ğŸ¯ çµ•å°ï¼é–±è®€å®ˆè­·";

            if (rank >= 11 && rank <= 20) return "ğŸ–ï¸ æ¦®è­½ï¼é–±è®€ç¦è¡›è»";
            if (rank >= 21 && rank <= 30) return "ğŸš€ éå‡¡ï¼é–±è®€å¾æœè€…";
            if (rank >= 31 && rank <= 40) return "âš¡ ç¨€æœ‰ï¼é–±è®€çªæ“ŠéšŠ";
            if (rank >= 41 && rank <= 50) return "ğŸŒªï¸ å‰½æ‚ï¼é–±è®€æ¯€æ»…è€…";
            if (rank >= 51 && rank <= 60) return "ğŸ—¡ï¸ é‹’åˆ©ï¼é–±è®€çµé­”äºº";
            if (rank >= 61 && rank <= 70) return "ğŸ¦… éŠ³åˆ©ï¼é–±è®€ç‹™æ“Šæ‰‹";
            if (rank >= 71 && rank <= 80) return "ğŸŒ‹ ç‹‚é‡ï¼é–±è®€å…ˆé‹’";
            if (rank >= 81 && rank <= 90) return "ğŸŒ² å …éŸŒï¼é–±è®€éŠä¿ ";
            if (rank >= 91 && rank <= 100) return "âœ¨ è¦ºé†’ï¼é–±è®€è¶…æ–°æ˜Ÿ";
            
            if (rank >= 101 && rank <= 200) return "ğŸ—ºï¸ è³‡æ·±å†’éšªå®¶";
            if (rank >= 201 && rank <= 300) return "ğŸ” çŸ¥è­˜æ¢ç´¢è€…";
            if (rank >= 301 && rank <= 400) return "ğŸ§™ è¦‹ç¿’é­”æ³•å¸«";
            if (rank >= 401 && rank <= 500) return "ğŸ‹ï¸ å‹¤å¥®ä¿®ç…‰è€…";
            if (rank >= 501 && rank <= 600) return "ğŸ¡ æ‘èŠæ–°ç§€";
            if (rank >= 601 && rank <= 800) return "ğŸŒ± æ—…é€”åˆå¿ƒè€…";
            
            return "ğŸŒ± æ—…é€”åˆå¿ƒè€…";
        }
        // --- æ–°å¢ï¼šå»ºè­°æ›¸å–®åŠŸèƒ½ ---
        function openSuggestModal() {
            document.getElementById('suggest-text').value = ''; // æ¸…ç©º
            document.getElementById('suggest-modal').style.display = 'flex';
        }

        function closeSuggestModal() {
            document.getElementById('suggest-modal').style.display = 'none';
        }

        async function submitSuggestion() {
            const content = document.getElementById('suggest-text').value.trim();
            if (!content) { alert("è«‹è¼¸å…¥å»ºè­°å…§å®¹å–”ï¼"); return; }

            const res = await callApi({
                action: "submitSuggestion",
                class: currentUser.class,
                seat: currentUser.seat,
                name: currentUser.name,
                content: content
            });

            if (res.success) {
                alert("âœ… å»ºè­°å·²é€å‡ºï¼è¬è¬ä½ çš„æ¨è–¦ï¼");
                closeSuggestModal();
            } else {
                alert("âŒ é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }
        }
        // --- ğŸ–ï¸ ç¨±è™Ÿç³»çµ±é‚è¼¯ ---
        function getRankTitle(rank, score) {
            // å„ªå…ˆåˆ¤æ–·ï¼šå¦‚æœåˆ†æ•¸ç‚º 0
            if (score === 0) return "ğŸ’¤ æ²‰ç¡çš„å‹‡è€…";
            
            // å¦‚æœæ²’æ’å (å¯èƒ½è³‡æ–™ç•°å¸¸)
            if (!rank || rank === "-") return "ğŸŒ± æ—…é€”åˆå¿ƒè€…";

            // ç‰¹æ®Šæ’å (1-10)
            if (rank === 1) return "ğŸ‘‘ å‚³å¥‡ï¼é–±è®€éœ¸ä¸»";
            if (rank === 2) return "âš”ï¸ æ¦®è€€ï¼å²è©©ç‹è€…";
            if (rank === 3) return "ğŸ’ ç’€ç’¨ï¼çµ•ä¸–é‘½çŸ³";
            if (rank === 4) return "âšœï¸ è¯è²´ï¼æ™ºæ…§æ³•çš‡";
            if (rank === 5) return "ğŸ”¥ ä¸æœ½ï¼æ™ºæ…§æˆ°ç¥";
            if (rank === 6) return "ğŸ”® å¥§ç§˜ï¼çŸ¥è­˜æ³•ç‹";
            if (rank === 7) return "ğŸ›¡ï¸ ç¥è–ï¼æ™ºæ…§è–é¨";
            if (rank === 8) return "ğŸ‰ éœ¸æ°£ï¼æ›¸æµ·é¾é¨";
            if (rank === 9) return "ğŸ©¸ ç†±è¡€ï¼é–±è®€é ˜ä¸»";
            if (rank === 10) return "ğŸ¯ çµ•å°ï¼é–±è®€å®ˆè­·";

            // å€é–“æ’å
            if (rank >= 11 && rank <= 20) return "ğŸ–ï¸ æ¦®è­½ï¼é–±è®€ç¦è¡›è»";
            if (rank >= 21 && rank <= 30) return "ğŸš€ éå‡¡ï¼é–±è®€å¾æœè€…";
            if (rank >= 31 && rank <= 40) return "âš¡ ç¨€æœ‰ï¼é–±è®€çªæ“ŠéšŠ";
            if (rank >= 41 && rank <= 50) return "ğŸŒªï¸ å‰½æ‚ï¼é–±è®€æ¯€æ»…è€…";
            if (rank >= 51 && rank <= 60) return "ğŸ—¡ï¸ é‹’åˆ©ï¼é–±è®€çµé­”äºº";
            if (rank >= 61 && rank <= 70) return "ğŸ¦… éŠ³åˆ©ï¼é–±è®€ç‹™æ“Šæ‰‹";
            if (rank >= 71 && rank <= 80) return "ğŸŒ‹ ç‹‚é‡ï¼é–±è®€å…ˆé‹’";
            if (rank >= 81 && rank <= 90) return "ğŸŒ² å …éŸŒï¼é–±è®€éŠä¿ ";
            if (rank >= 91 && rank <= 100) return "âœ¨ è¦ºé†’ï¼é–±è®€è¶…æ–°æ˜Ÿ";
            
            if (rank >= 101 && rank <= 200) return "ğŸ—ºï¸ è³‡æ·±å†’éšªå®¶";
            if (rank >= 201 && rank <= 300) return "ğŸ” çŸ¥è­˜æ¢ç´¢è€…";
            if (rank >= 301 && rank <= 400) return "ğŸ§™ è¦‹ç¿’é­”æ³•å¸«";
            if (rank >= 401 && rank <= 500) return "ğŸ‹ï¸ å‹¤å¥®ä¿®ç…‰è€…";
            if (rank >= 501 && rank <= 600) return "ğŸ¡ æ‘èŠæ–°ç§€";
            if (rank >= 601 && rank <= 800) return "ğŸŒ± æ—…é€”åˆå¿ƒè€…";
            
            return "ğŸŒ± æ—…é€”åˆå¿ƒè€…"; // é è¨­
        }

        function showView(viewId) {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            // åªæœ‰åœ¨æ’è¡Œæ¦œé é¢æ‰é¡¯ç¤ºåº•éƒ¨ Footer
            if(viewId === 'view-leaderboard') {
                // å·²åœ¨ fetchLeaderboard ä¸­æ§åˆ¶é¡¯ç¤ºï¼Œé€™è£¡ä¸éœ€å¼·åˆ¶éš±è—ï¼Œä¿æŒå½ˆæ€§
            } else {
                document.getElementById('my-rank-footer').style.display = 'none';
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function logout() { currentUser = null; location.reload(); }
		// --- ğŸ›ï¸ æ­·å±†æ¦®è­½æ¦œåŠŸèƒ½ (è‡ªå‹•ç¾åŒ–ç‰ˆ) ---
        async function fetchContestHistory() {
            showView('view-contest'); 
            const container = document.getElementById('contest-list-container');
            container.innerHTML = '<div class="spinner" style="margin:20px auto;"></div>';

            const res = await callApi({ action: "getContestHistory" });

            if (res.success && res.records.length > 0) {
                container.innerHTML = ''; 
                res.records.forEach((item) => {
                    // ğŸ‘‡ æ ¸å¿ƒé­”æ³•ï¼šæŠŠç´”æ–‡å­—åˆ‡æˆä¸€è¡Œä¸€è¡Œï¼Œä¸¦åŒ…è£æˆæ¼‚äº®çš„ HTML
                    let contentHtml = '';
                    if (item.content) {
                        // ä»¥æ›è¡Œç¬¦è™Ÿ (\n) åˆ‡å‰²ï¼Œä¸¦éæ¿¾æ‰ç©ºè¡Œ
                        contentHtml = item.content.split(/\n/).map(line => {
                            const cleanLine = line.trim();
                            if (cleanLine) {
                                // æ¯ä¸€è¡Œéƒ½è®Šæˆä¸€å€‹ divï¼Œå‰é¢åŠ ä¸Šçç‰Œåœ–ç¤º
                                return `<div class="award-row">ğŸ–ï¸ ${cleanLine}</div>`;
                            }
                            return '';
                        }).join('');
                    } else {
                        contentHtml = '<div style="padding:15px; color:#999;">(å°šç„¡åå–®)</div>';
                    }

                    const div = document.createElement('div');
                    div.className = 'contest-item';
                    div.innerHTML = `
                        <div class="contest-header" onclick="toggleContest(this)">
                            <span>${item.title} <span class="contest-date">${item.date}</span></span>
                            <span>â–¼</span>
                        </div>
                        <div class="contest-body">${contentHtml}</div>
                    `;
                    container.appendChild(div);
                });
            } else {
                container.innerHTML = '<div style="text-align:center; padding:30px; color:#aaa;">ğŸ“­ ç›®å‰é‚„æ²’æœ‰æ­·å²ç´€éŒ„å–”ï¼</div>';
            }
        } // â¬…ï¸ é€™è£¡è¦æœ‰ä¸€å€‹å¤§æ‹¬è™Ÿï¼ŒçµæŸ fetchContestHistory

        // --- è² è²¬åˆ‡æ›å±•é–‹/æ”¶åˆçš„å‡½å¼ (è¦æ”¾åœ¨å¤–é¢ï¼) ---
        function toggleContest(headerElement) {
            // æ‰¾åˆ°é€™ä¸€å€å¡Šçš„æœ€å¤–å±¤å®¹å™¨ (.contest-item)
            const item = headerElement.parentElement;
            
            // åˆ‡æ› open æ¨£å¼ (æœ‰ open å°±æ‹¿æ‰ï¼Œæ²’ open å°±åŠ ä¸Š)
            item.classList.toggle('open');
            
            // åˆ‡æ›ç®­é ­æ–¹å‘ (é¸å–æœ€å¾Œä¸€å€‹ spanï¼Œä¹Ÿå°±æ˜¯é‚£å€‹ â–¼)
            const arrow = headerElement.querySelector('span:last-child');
            if (arrow) {
                arrow.textContent = item.classList.contains('open') ? 'â–²' : 'â–¼';
            }
        }
// --- âš”ï¸ ç­ç´šå°æŠ—è³½åŠŸèƒ½ ---
        async function fetchClassPK() {
            showView('view-class-pk');
            const container = document.getElementById('class-pk-list');
            container.innerHTML = '<div class="spinner" style="margin:20px auto;"></div>';

            const res = await callApi({ action: "getClassLeaderboard" });

            if (res.success && res.list.length > 0) {
                container.innerHTML = '';
                
                // æ‰¾å‡ºæœ€é«˜åˆ†ï¼Œç”¨ä¾†è¨ˆç®—é•·æ¢åœ–æ¯”ä¾‹
                const maxScore = res.list[0].average;

                res.list.forEach((item, index) => {
                    const rank = index + 1;
                    let icon = `<span style="color:#ccc; width:25px; display:inline-block;">#${rank}</span>`;
                    let rankClass = "";

                    if (rank === 1) { icon = "ğŸ†"; rankClass = "pk-rank-1"; }
                    if (rank === 2) { icon = "ğŸ¥ˆ"; rankClass = "pk-rank-2"; }
                    if (rank === 3) { icon = "ğŸ¥‰"; rankClass = "pk-rank-3"; }

                    const widthPercent = maxScore > 0 ? (item.average / maxScore) * 100 : 0;

                    const div = document.createElement('div');
                    div.className = `pk-item ${rankClass}`;
                    div.innerHTML = `
                        <div class="pk-info">
                            <span>${icon} ${item.className}</span>
                            <span>å¹³å‡: <span style="font-size:1.1rem; color:#333;">${item.average}</span> åˆ†</span>
                        </div>
                        <div class="pk-bar-bg">
                            <div class="pk-bar-fill" style="width: 0%">
                                ${item.totalScore} ç¸½åˆ†
                            </div>
                        </div>
                    `;
                    container.appendChild(div);

                    setTimeout(() => {
                        const bar = div.querySelector('.pk-bar-fill');
                        if(bar) bar.style.width = `${widthPercent}%`;
                    }, 100 + (index * 100));
                });
            } else {
                // ğŸ‘‡ ä¹‹å‰å°‘çš„å°±æ˜¯é€™å€‹ else
                container.innerHTML = '<div style="text-align:center; padding:30px; color:#aaa;">ğŸ’¤ ç›®å‰æˆ°æ³ä¸€ç‰‡å¯‚éœ...</div>';
            }
        }

    </script>
	
	
</body>
</html>